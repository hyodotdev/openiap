name: Google Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (without v prefix, e.g. 1.2.14)'
        required: true
        type: string

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseParallelGC"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version
      id: version
      run: |
        VERSION="${{ github.event.inputs.version }}"
        # Trim leading 'v' if present
        VERSION="${VERSION#v}"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Check if tag already exists
      id: check_tag
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        if git rev-parse "google-v$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "❌ Tag google-v$VERSION already exists. Skipping release."
          exit 1
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "✓ Tag google-v$VERSION does not exist, proceeding with release"
        fi

    - name: Update version in openiap-versions.json
      working-directory: packages/google
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        # Update version in openiap-versions.json
        jq --arg version "$VERSION" '.google = $version' ../../openiap-versions.json > temp.json
        mv temp.json ../../openiap-versions.json

    - name: Sync version files
      run: ./scripts/sync-versions.sh

    - name: Commit version update
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add openiap-versions.json packages/*/openiap-versions.json

        if git diff --staged --quiet; then
          echo "No version changes to commit"
        else
          git commit -m "chore(google): bump version to $VERSION"
          git push origin main
        fi

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        cache-read-only: true

    - name: Grant execute permission for gradlew
      working-directory: packages/google
      run: chmod +x gradlew

    - name: Build and Test
      working-directory: packages/google
      env:
        ORG_GRADLE_PROJECT_openIapVersion: ${{ steps.version.outputs.version }}
      run: |
        ./gradlew :openiap:build --no-daemon --stacktrace
        ./gradlew :openiap:test --no-daemon --stacktrace

    - name: Check if Horizon flavor already published
      id: check_horizon
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        if curl -s "https://repo1.maven.org/maven2/io/github/hyochan/openiap/openiap-google-horizon/$VERSION/" | grep -q "$VERSION"; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "⚠️ openiap-google-horizon $VERSION already exists on Maven Central"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "✓ openiap-google-horizon $VERSION does not exist, will publish"
        fi

    - name: Publish Horizon flavor to Maven Central
      if: steps.check_horizon.outputs.exists == 'false'
      working-directory: packages/google
      env:
        ORG_GRADLE_PROJECT_openIapVersion: ${{ steps.version.outputs.version }}
        ORG_GRADLE_PROJECT_OPENIAP_PUBLISH_VARIANT: horizon
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
        ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
      run: |
        if [ -z "$ORG_GRADLE_PROJECT_mavenCentralUsername" ]; then
          echo "⚠️ Maven Central credentials not set. Skipping publish."
        else
          ./gradlew :openiap:publishAndReleaseToMavenCentral --no-daemon --no-parallel --stacktrace
          echo "✅ Published openiap-google-horizon (Horizon flavor) to Maven Central"
        fi

    - name: Check if Play flavor already published
      id: check_play
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        if curl -s "https://repo1.maven.org/maven2/io/github/hyochan/openiap/openiap-google/$VERSION/" | grep -q "$VERSION"; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "⚠️ openiap-google $VERSION already exists on Maven Central"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "✓ openiap-google $VERSION does not exist, will publish"
        fi

    - name: Publish Play flavor to Maven Central
      if: steps.check_play.outputs.exists == 'false'
      working-directory: packages/google
      env:
        ORG_GRADLE_PROJECT_openIapVersion: ${{ steps.version.outputs.version }}
        ORG_GRADLE_PROJECT_OPENIAP_PUBLISH_VARIANT: play
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
        ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
      run: |
        if [ -z "$ORG_GRADLE_PROJECT_mavenCentralUsername" ]; then
          echo "⚠️ Maven Central credentials not set. Skipping publish."
        else
          ./gradlew :openiap:publishAndReleaseToMavenCentral --no-daemon --no-parallel --stacktrace
          echo "✅ Published openiap-google (Play flavor) to Maven Central"
        fi

    - name: Create release artifacts
      working-directory: packages/google
      run: |
        mkdir -p release-artifacts
        cp openiap/build/outputs/aar/*.aar release-artifacts/ 2>/dev/null || echo "No AAR files found"
        cp openiap/build/libs/*.jar release-artifacts/ 2>/dev/null || echo "No JAR files found"
        if [ -d release-artifacts ] && [ "$(ls -A release-artifacts)" ]; then
          (cd release-artifacts && shasum -a 256 * > ../checksums.txt) || true
          zip -r release-artifacts.zip release-artifacts/
        fi

    - name: Create and push tag
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check if tag already exists
        if git rev-parse "google-v$VERSION" >/dev/null 2>&1; then
          echo "Tag google-v$VERSION already exists"
        else
          git tag "google-v$VERSION"
          git push origin "google-v$VERSION"
          echo "✅ Created and pushed tag google-v$VERSION"
        fi

    - name: Create GitHub Release
      working-directory: packages/google
      env:
        VERSION: ${{ steps.version.outputs.version }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Upload artifacts if they exist
        ARTIFACTS=""
        if [ -f release-artifacts.zip ]; then
          ARTIFACTS="$ARTIFACTS release-artifacts.zip"
        fi
        if [ -f checksums.txt ]; then
          ARTIFACTS="$ARTIFACTS checksums.txt"
        fi

        # Generate release notes with changelog
        gh release create "google-v$VERSION" \
          $ARTIFACTS \
          --title "Google v$VERSION" \
          --latest \
          --generate-notes \
          --notes "## OpenIAP Google v$VERSION

        ### Installation

        #### For Google Play Store (Play flavor)

        **Gradle (Kotlin DSL):**
        \`\`\`kotlin
        dependencies {
            implementation(\"io.github.hyochan.openiap:openiap-google:$VERSION\")
        }
        \`\`\`

        **Gradle (Groovy):**
        \`\`\`groovy
        dependencies {
            implementation 'io.github.hyochan.openiap:openiap-google:$VERSION'
        }
        \`\`\`

        #### For Meta Quest/Horizon Store (Horizon flavor)

        **Gradle (Kotlin DSL):**
        \`\`\`kotlin
        dependencies {
            implementation(\"io.github.hyochan.openiap:openiap-google-horizon:$VERSION\")
        }
        \`\`\`

        **Gradle (Groovy):**
        \`\`\`groovy
        dependencies {
            implementation 'io.github.hyochan.openiap:openiap-google-horizon:$VERSION'
        }
        \`\`\`

        ### Documentation
        - [API Documentation](https://openiap.dev)
        - [GitHub](https://github.com/hyodotdev/openiap/tree/main/packages/google)

        ### Maven Central
        - [openiap-google (Play)](https://central.sonatype.com/artifact/io.github.hyochan.openiap/openiap-google/$VERSION)
        - [openiap-google-horizon (Horizon)](https://central.sonatype.com/artifact/io.github.hyochan.openiap/openiap-google-horizon/$VERSION)"
