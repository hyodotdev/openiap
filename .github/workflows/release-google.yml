name: Google Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Choose version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseParallelGC"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Calculate new version
      id: version
      run: |
        # Read current google version from openiap-versions.json
        CURRENT_VERSION=$(jq -r '.google' openiap-versions.json)
        echo "Current version: $CURRENT_VERSION"

        # Parse version components
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

        # Bump version based on input
        case "${{ github.event.inputs.version }}" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac

        NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
        echo "New version: $NEW_VERSION"
        echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Check if tag already exists
      id: check_tag
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        if git rev-parse "google-$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "❌ Tag google-$VERSION already exists. Skipping release."
          exit 1
        fi

        if git rev-parse "google-v$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "❌ Legacy tag google-v$VERSION already exists. Choose a new version."
          exit 1
        fi

        echo "exists=false" >> $GITHUB_OUTPUT
        echo "✓ Tag google-$VERSION does not exist, proceeding with release"

    - name: Update version in openiap-versions.json
      working-directory: packages/google
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        # Update version in openiap-versions.json
        jq --arg version "$VERSION" '.google = $version' ../../openiap-versions.json > temp.json
        mv temp.json ../../openiap-versions.json

    - name: Sync version files
      run: ./scripts/sync-versions.sh

    - name: Commit version update
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add openiap-versions.json packages/*/openiap-versions.json

        if git diff --staged --quiet; then
          echo "No version changes to commit"
        else
          git commit -m "chore(google): bump version to $VERSION"

          # Pull latest changes before pushing
          git pull --rebase origin main || true

          # Retry push up to 3 times with exponential backoff
          for i in 1 2 3; do
            if git push origin main; then
              echo "✅ Successfully pushed version update"
              break
            else
              if [ $i -lt 3 ]; then
                echo "⚠️ Push failed, retrying in $((i * 2)) seconds..."
                sleep $((i * 2))
              else
                echo "❌ Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done
        fi

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        cache-read-only: true

    - name: Grant execute permission for gradlew
      working-directory: packages/google
      run: chmod +x gradlew

    - name: Build and Test
      working-directory: packages/google
      env:
        ORG_GRADLE_PROJECT_openIapVersion: ${{ steps.version.outputs.version }}
      run: |
        ./gradlew :openiap:build --no-daemon --stacktrace
        ./gradlew :openiap:test --no-daemon --stacktrace

    - name: Check if Horizon flavor already published
      id: check_horizon
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        if curl -s "https://repo1.maven.org/maven2/io/github/hyochan/openiap/openiap-google-horizon/$VERSION/" | grep -q "$VERSION"; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "⚠️ openiap-google-horizon $VERSION already exists on Maven Central"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "✓ openiap-google-horizon $VERSION does not exist, will publish"
        fi

    - name: Publish Horizon flavor to Maven Central
      if: steps.check_horizon.outputs.exists == 'false'
      working-directory: packages/google
      env:
        ORG_GRADLE_PROJECT_openIapVersion: ${{ steps.version.outputs.version }}
        ORG_GRADLE_PROJECT_OPENIAP_PUBLISH_VARIANT: horizon
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
        ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
      run: |
        if [ -z "$ORG_GRADLE_PROJECT_mavenCentralUsername" ]; then
          echo "⚠️ Maven Central credentials not set. Skipping publish."
        else
          ./gradlew :openiap:publishAndReleaseToMavenCentral --no-daemon --no-parallel --stacktrace
          echo "✅ Published openiap-google-horizon (Horizon flavor) to Maven Central"
        fi

    - name: Check if Play flavor already published
      id: check_play
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        if curl -s "https://repo1.maven.org/maven2/io/github/hyochan/openiap/openiap-google/$VERSION/" | grep -q "$VERSION"; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "⚠️ openiap-google $VERSION already exists on Maven Central"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "✓ openiap-google $VERSION does not exist, will publish"
        fi

    - name: Publish Play flavor to Maven Central
      if: steps.check_play.outputs.exists == 'false'
      working-directory: packages/google
      env:
        ORG_GRADLE_PROJECT_openIapVersion: ${{ steps.version.outputs.version }}
        ORG_GRADLE_PROJECT_OPENIAP_PUBLISH_VARIANT: play
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
        ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
      run: |
        if [ -z "$ORG_GRADLE_PROJECT_mavenCentralUsername" ]; then
          echo "⚠️ Maven Central credentials not set. Skipping publish."
        else
          ./gradlew :openiap:publishAndReleaseToMavenCentral --no-daemon --no-parallel --stacktrace
          echo "✅ Published openiap-google (Play flavor) to Maven Central"
        fi

    - name: Create release artifacts
      working-directory: packages/google
      run: |
        mkdir -p release-artifacts
        cp openiap/build/outputs/aar/*.aar release-artifacts/ 2>/dev/null || echo "No AAR files found"
        cp openiap/build/libs/*.jar release-artifacts/ 2>/dev/null || echo "No JAR files found"
        if [ -d release-artifacts ] && [ "$(ls -A release-artifacts)" ]; then
          (cd release-artifacts && shasum -a 256 * > ../checksums.txt) || true
          zip -r release-artifacts.zip release-artifacts/
        fi

    - name: Create and push tag
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check if tag already exists
        if git rev-parse "google-$VERSION" >/dev/null 2>&1; then
          echo "Tag google-$VERSION already exists"
        else
          git tag "google-$VERSION"
          git push origin "google-$VERSION"
          echo "✅ Created and pushed tag google-$VERSION"
        fi

    - name: Generate release notes
      id: release_notes
      env:
        VERSION: ${{ steps.version.outputs.version }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get the previous google tag
        PREV_TAG=$(git for-each-ref --sort=-creatordate --format '%(refname:short)' 'refs/tags/google-*' | head -n 1)

        if [ -z "$PREV_TAG" ]; then
          echo "No previous google tag found"
          CHANGELOG="Initial release"
        else
          echo "Generating changelog from $PREV_TAG to HEAD"
          CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" -- packages/google/)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No changes in packages/google/"
          fi
        fi

        # Save changelog to file for multiline handling
        echo "$CHANGELOG" > /tmp/changelog.txt

        # Create release notes
        cat > /tmp/release-notes.md <<EOF
        ## OpenIAP Google $VERSION

        ### What's Changed
        $CHANGELOG

        ### Installation

        #### For Google Play Store (Play flavor)

        **Gradle (Kotlin DSL):**
        \`\`\`kotlin
        dependencies {
            implementation("io.github.hyochan.openiap:openiap-google:$VERSION")
        }
        \`\`\`

        **Gradle (Groovy):**
        \`\`\`groovy
        dependencies {
            implementation 'io.github.hyochan.openiap:openiap-google:$VERSION'
        }
        \`\`\`

        #### For Meta Quest/Horizon Store (Horizon flavor)

        **Gradle (Kotlin DSL):**
        \`\`\`kotlin
        dependencies {
            implementation("io.github.hyochan.openiap:openiap-google-horizon:$VERSION")
        }
        \`\`\`

        **Gradle (Groovy):**
        \`\`\`groovy
        dependencies {
            implementation 'io.github.hyochan.openiap:openiap-google-horizon:$VERSION'
        }
        \`\`\`

        ### Documentation
        - [API Documentation](https://openiap.dev)
        - [GitHub](https://github.com/hyodotdev/openiap/tree/main/packages/google)

        ### Maven Central
        - [openiap-google (Play)](https://central.sonatype.com/artifact/io.github.hyochan.openiap/openiap-google/$VERSION)
        - [openiap-google-horizon (Horizon)](https://central.sonatype.com/artifact/io.github.hyochan.openiap/openiap-google-horizon/$VERSION)
        EOF

    - name: Create GitHub Release
      working-directory: packages/google
      env:
        VERSION: ${{ steps.version.outputs.version }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Upload artifacts if they exist
        ARTIFACTS=""
        if [ -f release-artifacts.zip ]; then
          ARTIFACTS="$ARTIFACTS release-artifacts.zip"
        fi
        if [ -f checksums.txt ]; then
          ARTIFACTS="$ARTIFACTS checksums.txt"
        fi

        # Generate release notes with changelog
        gh release create "google-$VERSION" \
          $ARTIFACTS \
          --title "Google $VERSION" \
          --latest \
          --notes-file /tmp/release-notes.md
