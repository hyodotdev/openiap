name: Apple Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Choose version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      target_version:
        description: 'Manual version override (e.g., 1.3.5). Leave empty to auto-bump.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Calculate new version
      id: version
      run: |
        # Read current apple version from openiap-versions.json
        CURRENT_VERSION=$(jq -r '.apple' openiap-versions.json)
        echo "Current version: $CURRENT_VERSION"
        echo "PREVIOUS_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
        echo "previous_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        TARGET_VERSION="${{ github.event.inputs.target_version }}"

        if [ -n "$TARGET_VERSION" ]; then
          if [[ ! "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid target_version: $TARGET_VERSION. Must be MAJOR.MINOR.PATCH"
            exit 1
          fi
          NEW_VERSION="$TARGET_VERSION"
          echo "Using manual version: $NEW_VERSION"
        else
          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Bump version based on input
          case "${{ github.event.inputs.version }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"
        fi
        echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Check if tag already exists
      id: check_tag
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        if git rev-parse "$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "❌ Tag $VERSION already exists. Choose a new version."
          exit 1
        fi

        if git rev-parse "apple-v$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "❌ Legacy tag apple-v$VERSION already exists. Choose a new version."
          exit 1
        fi

        echo "exists=false" >> $GITHUB_OUTPUT
        echo "✓ Tag $VERSION does not exist, proceeding with release"

    - name: Update version in openiap-versions.json
      working-directory: packages/apple
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        # Update version in openiap-versions.json
        jq --arg version "$VERSION" '.apple = $version' ../../openiap-versions.json > temp.json
        mv temp.json ../../openiap-versions.json

    - name: Sync version files
      run: ./scripts/sync-versions.sh

    - name: Commit version update
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add openiap-versions.json packages/*/openiap-versions.json

        if git diff --staged --quiet; then
          echo "No version changes to commit"
        else
          git commit -m "chore(apple): bump version to $VERSION"

          # Pull latest changes before pushing
          git pull --rebase origin main || true

          # Retry push up to 3 times with exponential backoff
          for i in 1 2 3; do
            if git push origin main; then
              echo "✅ Successfully pushed version update"
              break
            else
              if [ $i -lt 3 ]; then
                echo "⚠️ Push failed, retrying in $((i * 2)) seconds..."
                sleep $((i * 2))
              else
                echo "❌ Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done
        fi

    - name: Select Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode.app

    - name: Build and Test
      working-directory: packages/apple
      run: |
        swift build
        swift test

    - name: Create and push tag
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Check if tag already exists
        if git rev-parse "$VERSION" >/dev/null 2>&1; then
          echo "Tag $VERSION already exists"
        else
          git tag "$VERSION"
          git push origin "$VERSION"
          echo "✅ Created and pushed tag $VERSION"
        fi

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: false

    - name: Install CocoaPods
      run: |
        gem install cocoapods

    - name: Validate Podspec
      id: validate_podspec
      run: |
        # Remove symlink if exists and copy podspec to root for validation
        rm -f openiap.podspec
        cp packages/apple/openiap.podspec .
        pod lib lint openiap.podspec --allow-warnings

    - name: Cleanup on validation failure
      if: failure() && steps.validate_podspec.outcome == 'failure'
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        echo "❌ Podspec validation failed. Cleaning up tag and commit..."

        # Delete the tag locally and remotely
        git tag -d "$VERSION" || true
        git push origin :refs/tags/"$VERSION" || true

        echo "✅ Deleted tag $VERSION"

    - name: Deploy to CocoaPods
      env:
        COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        COCOAPODS_VALIDATOR_SKIP_XCODEBUILD: 1
        CI: true
      run: |
        if [ -z "$COCOAPODS_TRUNK_TOKEN" ]; then
          echo "⚠️ COCOAPODS_TRUNK_TOKEN is not set. Skipping CocoaPods publish."
        else
          pod trunk push openiap.podspec --allow-warnings --skip-tests --verbose
          echo "✅ Published to CocoaPods"
        fi

    - name: Generate release notes
      id: release_notes
      env:
        VERSION: ${{ steps.version.outputs.version }}
        PREVIOUS_VERSION: ${{ steps.version.outputs.previous_version }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get the previous apple tag
        PREV_TAG=""

        if [ -n "$PREVIOUS_VERSION" ]; then
          if git rev-parse "$PREVIOUS_VERSION" >/dev/null 2>&1; then
            PREV_TAG="$PREVIOUS_VERSION"
          elif git rev-parse "apple-v$PREVIOUS_VERSION" >/dev/null 2>&1; then
            PREV_TAG="apple-v$PREVIOUS_VERSION"
          fi
        fi

        if [ -z "$PREV_TAG" ]; then
          echo "No previous apple tag found"
          CHANGELOG="Initial release"
        else
          echo "Generating changelog from $PREV_TAG to HEAD"
          CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" -- packages/apple/)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No changes in packages/apple/"
          fi
        fi

        # Save changelog to file for multiline handling
        echo "$CHANGELOG" > /tmp/changelog.txt

        # Create release notes
        cat > /tmp/release-notes.md <<EOF
        ## OpenIAP Apple $VERSION

        ### What's Changed
        $CHANGELOG

        ### Installation

        **CocoaPods:**
        \`\`\`ruby
        pod 'openiap', '~> $VERSION'
        \`\`\`

        **Swift Package Manager:**
        \`\`\`swift
        dependencies: [
            .package(url: "https://github.com/hyodotdev/openiap.git", from: "$VERSION")
        ]
        \`\`\`

        ### Documentation
        - [API Documentation](https://openiap.dev)
        - [GitHub](https://github.com/hyodotdev/openiap/tree/main/packages/apple)
        EOF

    - name: Create GitHub Release
      env:
        VERSION: ${{ steps.version.outputs.version }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create "$VERSION" \
          --title "Apple $VERSION" \
          --latest \
          --notes-file /tmp/release-notes.md
