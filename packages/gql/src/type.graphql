# openiap.dev GraphQL Types for cross-platform IAP (common)

# Platform discriminators
enum IapPlatform {
  IOS
  Android
}

# Common product types
enum ProductType {
  InApp
  Subs
}

# Purchase lifecycle states
enum PurchaseState {
  Pending
  Purchased
  Failed
  Restored
  Deferred
  Unknown
}

# Event types emitted by OpenIAP listeners
enum IapEvent {
  PurchaseUpdated
  PurchaseError
  PromotedProductIOS
  UserChoiceBillingAndroid
}

# Purchase verification providers
enum PurchaseVerificationProvider {
  Iapkit
}

enum IapStore {
  Unknown
  Apple
  Google
  Horizon
}

# Common product fields
interface ProductCommon {
  id: ID!
  title: String!
  description: String!
  type: ProductType!
  displayName: String
  displayPrice: String!
  currency: String!
  price: Float
  debugDescription: String
  platform: IapPlatform!
}

# Common purchase fields
interface PurchaseCommon {
  id: ID!
  productId: String!
  ids: [String!]
  transactionDate: Float!
  """
  Unified purchase token (iOS JWS, Android purchaseToken)
  """
  purchaseToken: String
  """
  Store where purchase was made
  """
  store: IapStore!
  platform: IapPlatform! @deprecated(reason: "Use store instead")
  quantity: Int!
  purchaseState: PurchaseState!
  isAutoRenewing: Boolean!
  """
  The current plan identifier. This is:
  - On Android: the basePlanId (e.g., "premium", "premium-year")
  - On iOS: the productId (e.g., "com.example.premium_monthly", "com.example.premium_yearly")
  This provides a unified way to identify which specific plan/tier the user is subscribed to.
  """
  currentPlanId: String
}

# Unions for platform-specific types
union Product = ProductAndroid | ProductIOS
union ProductSubscription = ProductSubscriptionAndroid | ProductSubscriptionIOS
union Purchase = PurchaseAndroid | PurchaseIOS

# Generic result for APIs that do not return payloads
type VoidResult {
  success: Boolean!
}

# Product or Subscription union for 'all' type
union ProductOrSubscription = Product | ProductSubscription

# => Union
# Product fetch responses can return products, subscriptions, or both
type FetchProductsResult {
  products: [Product!]
  subscriptions: [ProductSubscription!]
  all: [ProductOrSubscription!]
}

# => Union
# Result container for requestPurchase (iOS returns a single purchase, Android an array)
type RequestPurchaseResult {
  purchase: Purchase
  purchases: [Purchase!]
}

# Product request parameters
enum ProductQueryType {
  InApp
  Subs
  All
}

input ProductRequest {
  skus: [String!]!
  type: ProductQueryType = InApp
}

# Optional filters when querying existing purchases or subscriptions
input PurchaseOptions {
  """
  Also emit results through the iOS event listeners
  """
  alsoPublishToEventListenerIOS: Boolean
  """
  Limit to currently active items on iOS
  """
  onlyIncludeActiveItemsIOS: Boolean
}

# Parameters for requestPurchase
input RequestPurchaseProps {
  """
  Per-platform purchase request props
  """
  requestPurchase: RequestPurchasePropsByPlatforms
  """
  Per-platform subscription request props
  """
  requestSubscription: RequestSubscriptionPropsByPlatforms
  """
  Explicit purchase type hint (defaults to in-app)
  """
  type: ProductQueryType = InApp
  """
  Use alternative billing (Google Play alternative billing, Apple external purchase link)
  """
  useAlternativeBilling: Boolean
}

# Minimal purchase information required to finish transactions
input PurchaseInput {
  id: ID!
  productId: String!
  ids: [String!]
  transactionDate: Float!
  purchaseToken: String
  """
  Store where purchase was made
  """
  store: IapStore
  """
  @deprecated Use store instead
  """
  platform: IapPlatform
  quantity: Int!
  purchaseState: PurchaseState!
  isAutoRenewing: Boolean!
}

# Options for deep linking into subscription management
input DeepLinkOptions {
  """
  Android SKU to open (required on Android)
  """
  skuAndroid: String
  """
  Android package name to target (required on Android)
  """
  packageNameAndroid: String
}

"""
Platform-specific purchase request parameters.

Note: "Platforms" refers to the SDK/OS level (apple, google), not the store.
- apple: Always targets App Store
- google: Targets Play Store by default, or Horizon when built with horizon flavor
  (determined at build time, not runtime)
"""
input RequestPurchasePropsByPlatforms {
  """
  Apple-specific purchase parameters
  """
  apple: RequestPurchaseIosProps
  """
  Google-specific purchase parameters
  """
  google: RequestPurchaseAndroidProps
  """
  @deprecated Use apple instead
  """
  ios: RequestPurchaseIosProps
  """
  @deprecated Use google instead
  """
  android: RequestPurchaseAndroidProps
}

"""
Platform-specific subscription request parameters.

Note: "Platforms" refers to the SDK/OS level (apple, google), not the store.
- apple: Always targets App Store
- google: Targets Play Store by default, or Horizon when built with horizon flavor
  (determined at build time, not runtime)
"""
input RequestSubscriptionPropsByPlatforms {
  """
  Apple-specific subscription parameters
  """
  apple: RequestSubscriptionIosProps
  """
  Google-specific subscription parameters
  """
  google: RequestSubscriptionAndroidProps
  """
  @deprecated Use apple instead
  """
  ios: RequestSubscriptionIosProps
  """
  @deprecated Use google instead
  """
  android: RequestSubscriptionAndroidProps
}

# Receipt validation inputs and results
"""
Platform-specific purchase verification parameters.

- apple: Verifies via App Store Server API
- google: Verifies via Google Play Developer API
- horizon: Verifies via Meta's S2S API (verify_entitlement endpoint)
"""
input VerifyPurchaseProps {
  """
  Apple App Store verification parameters.
  """
  apple: VerifyPurchaseAppleOptions
  """
  Google Play Store verification parameters.
  """
  google: VerifyPurchaseGoogleOptions
  """
  Meta Horizon (Quest) verification parameters.
  """
  horizon: VerifyPurchaseHorizonOptions
}

union VerifyPurchaseResult =
    VerifyPurchaseResultAndroid
  | VerifyPurchaseResultIOS
  | VerifyPurchaseResultHorizon

input RequestVerifyPurchaseWithIapkitAppleProps {
  """
  The JWS token returned with the purchase response.
  """
  jws: String!
}

input RequestVerifyPurchaseWithIapkitGoogleProps {
  """
  The token provided to the user's device when the product or subscription was purchased.
  """
  purchaseToken: String!
}

"""
Platform-specific verification parameters for IAPKit.

- apple: Verifies via App Store (JWS token)
- google: Verifies via Play Store (purchase token)
"""
input RequestVerifyPurchaseWithIapkitProps {
  """
  API key used for the Authorization header (Bearer {apiKey}).
  """
  apiKey: String
  """
  Apple App Store verification parameters.
  """
  apple: RequestVerifyPurchaseWithIapkitAppleProps
  """
  Google Play Store verification parameters.
  """
  google: RequestVerifyPurchaseWithIapkitGoogleProps
}

"""
Unified purchase states from IAPKit verification response.
"""
enum IapkitPurchaseState {
  """
  User is entitled to the product (purchase is complete and active).
  """
  ENTITLED
  """
  Receipt is valid but still needs server acknowledgment.
  """
  PENDING_ACKNOWLEDGMENT
  """
  Purchase is in progress or awaiting confirmation.
  """
  PENDING
  """
  Purchase was cancelled or refunded.
  """
  CANCELED
  """
  Subscription or entitlement has expired.
  """
  EXPIRED
  """
  Consumable purchase is ready to be fulfilled.
  """
  READY_TO_CONSUME
  """
  Consumable item has been fulfilled/consumed.
  """
  CONSUMED
  """
  Purchase state could not be determined.
  """
  UNKNOWN
  """
  Purchase receipt is not authentic (fraudulent or tampered).
  """
  INAUTHENTIC
}

type RequestVerifyPurchaseWithIapkitResult {
  store: IapStore!
  """
  Whether the purchase is valid (not falsified).
  """
  isValid: Boolean!
  """
  The current state of the purchase.
  """
  state: IapkitPurchaseState!
}

input VerifyPurchaseWithProviderProps {
  provider: PurchaseVerificationProvider!
  iapkit: RequestVerifyPurchaseWithIapkitProps
}

type VerifyPurchaseWithProviderResult {
  provider: PurchaseVerificationProvider!
  """
  IAPKit verification result
  """
  iapkit: RequestVerifyPurchaseWithIapkitResult
  """
  Error details if verification failed
  """
  errors: [VerifyPurchaseWithProviderError!]
}

type VerifyPurchaseWithProviderError {
  message: String!
  code: String
}

# Aggregated active subscription data across platforms
type ActiveSubscription {
  productId: String!
  isActive: Boolean!
  expirationDateIOS: Float
  autoRenewingAndroid: Boolean
  environmentIOS: String
  """
  @deprecated iOS only - use daysUntilExpirationIOS instead.
  Whether the subscription will expire soon (within 7 days).
  Consider using daysUntilExpirationIOS for more precise control.
  """
  willExpireSoon: Boolean
  daysUntilExpirationIOS: Float
  transactionId: String!
  purchaseToken: String
  transactionDate: Float!
  basePlanIdAndroid: String
  """
  Required for subscription upgrade/downgrade on Android
  """
  purchaseTokenAndroid: String
  """
  The current plan identifier. This is:
  - On Android: the basePlanId (e.g., "premium", "premium-year")
  - On iOS: the productId (e.g., "com.example.premium_monthly", "com.example.premium_yearly")
  This provides a unified way to identify which specific plan/tier the user is subscribed to.
  """
  currentPlanId: String
  """
  Renewal information from StoreKit 2 (iOS only). Contains details about subscription renewal status,
  pending upgrades/downgrades, and auto-renewal preferences.
  """
  renewalInfoIOS: RenewalInfoIOS
}

# Initialization configuration
"""
Connection initialization configuration
"""
input InitConnectionConfig {
  """
  Alternative billing mode for Android
  If not specified, defaults to NONE (standard Google Play billing)
  """
  alternativeBillingModeAndroid: AlternativeBillingModeAndroid
}
