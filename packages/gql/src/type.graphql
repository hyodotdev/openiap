# openiap.dev GraphQL Types for cross-platform IAP (common)

# Platform discriminators
enum IapPlatform {
  IOS
  Android
}

# Common product types
enum ProductType {
  InApp
  Subs
}

# Purchase lifecycle states
enum PurchaseState {
  Pending
  Purchased
  Unknown
}

# Event types emitted by OpenIAP listeners
enum IapEvent {
  PurchaseUpdated
  PurchaseError
  PromotedProductIOS
  UserChoiceBillingAndroid
  """
  Fired when user selects developer-provided billing option in external payments flow.
  Available on Android with Google Play Billing Library 8.3.0+
  """
  DeveloperProvidedBillingAndroid
}

# Purchase verification providers
enum PurchaseVerificationProvider {
  Iapkit
}

enum IapStore {
  Unknown
  Apple
  Google
  Horizon
}

# Common product fields
interface ProductCommon {
  id: ID!
  title: String!
  description: String!
  type: ProductType!
  displayName: String
  displayPrice: String!
  currency: String!
  price: Float
  debugDescription: String
  platform: IapPlatform!
}

# Common purchase fields
interface PurchaseCommon {
  id: ID!
  productId: String!
  ids: [String!]
  transactionDate: Float!
  """
  Unified purchase token (iOS JWS, Android purchaseToken)
  """
  purchaseToken: String
  """
  Store where purchase was made
  """
  store: IapStore!
  platform: IapPlatform! @deprecated(reason: "Use store instead")
  quantity: Int!
  purchaseState: PurchaseState!
  isAutoRenewing: Boolean!
  """
  The current plan identifier. This is:
  - On Android: the basePlanId (e.g., "premium", "premium-year")
  - On iOS: the productId (e.g., "com.example.premium_monthly", "com.example.premium_yearly")
  This provides a unified way to identify which specific plan/tier the user is subscribed to.
  """
  currentPlanId: String
}

# Unions for platform-specific types
union Product = ProductAndroid | ProductIOS
union ProductSubscription = ProductSubscriptionAndroid | ProductSubscriptionIOS
union Purchase = PurchaseAndroid | PurchaseIOS

# Generic result for APIs that do not return payloads
type VoidResult {
  success: Boolean!
}

# Product or Subscription union for 'all' type
union ProductOrSubscription = Product | ProductSubscription

# => Union
# Product fetch responses can return products, subscriptions, or both
type FetchProductsResult {
  products: [Product!]
  subscriptions: [ProductSubscription!]
  all: [ProductOrSubscription!]
}

# => Union
# Result container for requestPurchase (iOS returns a single purchase, Android an array)
type RequestPurchaseResult {
  purchase: Purchase
  purchases: [Purchase!]
}

# Product request parameters
enum ProductQueryType {
  InApp
  Subs
  All
}

input ProductRequest {
  skus: [String!]!
  type: ProductQueryType = InApp
}

# Optional filters when querying existing purchases or subscriptions
input PurchaseOptions {
  """
  Also emit results through the iOS event listeners
  """
  alsoPublishToEventListenerIOS: Boolean
  """
  Limit to currently active items on iOS
  """
  onlyIncludeActiveItemsIOS: Boolean
}

# Parameters for requestPurchase
input RequestPurchaseProps {
  """
  Per-platform purchase request props
  """
  requestPurchase: RequestPurchasePropsByPlatforms
  """
  Per-platform subscription request props
  """
  requestSubscription: RequestSubscriptionPropsByPlatforms
  """
  Explicit purchase type hint (defaults to in-app)
  """
  type: ProductQueryType = InApp
  """
  @deprecated Use enableBillingProgramAndroid in InitConnectionConfig instead.
  This flag only logs debug info and has no effect on the purchase flow.
  """
  useAlternativeBilling: Boolean
}

# Minimal purchase information required to finish transactions
input PurchaseInput {
  id: ID!
  productId: String!
  ids: [String!]
  transactionDate: Float!
  purchaseToken: String
  """
  Store where purchase was made
  """
  store: IapStore
  """
  @deprecated Use store instead
  """
  platform: IapPlatform
  quantity: Int!
  purchaseState: PurchaseState!
  isAutoRenewing: Boolean!
}

# Options for deep linking into subscription management
input DeepLinkOptions {
  """
  Android SKU to open (required on Android)
  """
  skuAndroid: String
  """
  Android package name to target (required on Android)
  """
  packageNameAndroid: String
}

"""
Platform-specific purchase request parameters.

Note: "Platforms" refers to the SDK/OS level (apple, google), not the store.
- apple: Always targets App Store
- google: Targets Play Store by default, or Horizon when built with horizon flavor
  (determined at build time, not runtime)
"""
input RequestPurchasePropsByPlatforms {
  """
  Apple-specific purchase parameters
  """
  apple: RequestPurchaseIosProps
  """
  Google-specific purchase parameters
  """
  google: RequestPurchaseAndroidProps
  """
  @deprecated Use apple instead
  """
  ios: RequestPurchaseIosProps
  """
  @deprecated Use google instead
  """
  android: RequestPurchaseAndroidProps
}

"""
Platform-specific subscription request parameters.

Note: "Platforms" refers to the SDK/OS level (apple, google), not the store.
- apple: Always targets App Store
- google: Targets Play Store by default, or Horizon when built with horizon flavor
  (determined at build time, not runtime)
"""
input RequestSubscriptionPropsByPlatforms {
  """
  Apple-specific subscription parameters
  """
  apple: RequestSubscriptionIosProps
  """
  Google-specific subscription parameters
  """
  google: RequestSubscriptionAndroidProps
  """
  @deprecated Use apple instead
  """
  ios: RequestSubscriptionIosProps
  """
  @deprecated Use google instead
  """
  android: RequestSubscriptionAndroidProps
}

# Receipt validation inputs and results
"""
Platform-specific purchase verification parameters.

- apple: Verifies via App Store Server API
- google: Verifies via Google Play Developer API
- horizon: Verifies via Meta's S2S API (verify_entitlement endpoint)
"""
input VerifyPurchaseProps {
  """
  Apple App Store verification parameters.
  """
  apple: VerifyPurchaseAppleOptions
  """
  Google Play Store verification parameters.
  """
  google: VerifyPurchaseGoogleOptions
  """
  Meta Horizon (Quest) verification parameters.
  """
  horizon: VerifyPurchaseHorizonOptions
}

union VerifyPurchaseResult =
    VerifyPurchaseResultAndroid
  | VerifyPurchaseResultIOS
  | VerifyPurchaseResultHorizon

input RequestVerifyPurchaseWithIapkitAppleProps {
  """
  The JWS token returned with the purchase response.
  """
  jws: String!
}

input RequestVerifyPurchaseWithIapkitGoogleProps {
  """
  The token provided to the user's device when the product or subscription was purchased.
  """
  purchaseToken: String!
}

"""
Platform-specific verification parameters for IAPKit.

- apple: Verifies via App Store (JWS token)
- google: Verifies via Play Store (purchase token)
"""
input RequestVerifyPurchaseWithIapkitProps {
  """
  API key used for the Authorization header (Bearer {apiKey}).
  """
  apiKey: String
  """
  Apple App Store verification parameters.
  """
  apple: RequestVerifyPurchaseWithIapkitAppleProps
  """
  Google Play Store verification parameters.
  """
  google: RequestVerifyPurchaseWithIapkitGoogleProps
}

"""
Unified purchase states from IAPKit verification response.
"""
enum IapkitPurchaseState {
  """
  User is entitled to the product (purchase is complete and active).
  """
  ENTITLED
  """
  Receipt is valid but still needs server acknowledgment.
  """
  PENDING_ACKNOWLEDGMENT
  """
  Purchase is in progress or awaiting confirmation.
  """
  PENDING
  """
  Purchase was cancelled or refunded.
  """
  CANCELED
  """
  Subscription or entitlement has expired.
  """
  EXPIRED
  """
  Consumable purchase is ready to be fulfilled.
  """
  READY_TO_CONSUME
  """
  Consumable item has been fulfilled/consumed.
  """
  CONSUMED
  """
  Purchase state could not be determined.
  """
  UNKNOWN
  """
  Purchase receipt is not authentic (fraudulent or tampered).
  """
  INAUTHENTIC
}

type RequestVerifyPurchaseWithIapkitResult {
  store: IapStore!
  """
  Whether the purchase is valid (not falsified).
  """
  isValid: Boolean!
  """
  The current state of the purchase.
  """
  state: IapkitPurchaseState!
}

input VerifyPurchaseWithProviderProps {
  provider: PurchaseVerificationProvider!
  iapkit: RequestVerifyPurchaseWithIapkitProps
}

type VerifyPurchaseWithProviderResult {
  provider: PurchaseVerificationProvider!
  """
  IAPKit verification result
  """
  iapkit: RequestVerifyPurchaseWithIapkitResult
  """
  Error details if verification failed
  """
  errors: [VerifyPurchaseWithProviderError!]
}

type VerifyPurchaseWithProviderError {
  message: String!
  code: String
}

# Aggregated active subscription data across platforms
type ActiveSubscription {
  productId: String!
  isActive: Boolean!
  expirationDateIOS: Float
  autoRenewingAndroid: Boolean
  environmentIOS: String
  """
  @deprecated iOS only - use daysUntilExpirationIOS instead.
  Whether the subscription will expire soon (within 7 days).
  Consider using daysUntilExpirationIOS for more precise control.
  """
  willExpireSoon: Boolean
  daysUntilExpirationIOS: Float
  transactionId: String!
  purchaseToken: String
  transactionDate: Float!
  basePlanIdAndroid: String
  """
  Required for subscription upgrade/downgrade on Android
  """
  purchaseTokenAndroid: String
  """
  The current plan identifier. This is:
  - On Android: the basePlanId (e.g., "premium", "premium-year")
  - On iOS: the productId (e.g., "com.example.premium_monthly", "com.example.premium_yearly")
  This provides a unified way to identify which specific plan/tier the user is subscribed to.
  """
  currentPlanId: String
  """
  Renewal information from StoreKit 2 (iOS only). Contains details about subscription renewal status,
  pending upgrades/downgrades, and auto-renewal preferences.
  """
  renewalInfoIOS: RenewalInfoIOS
}

# =============================================================================
# Standardized Discount/Offer Types (Cross-Platform)
# =============================================================================
# These types provide a unified interface for discount and offer handling
# across iOS and Android platforms. Platform-specific fields use suffixes.
# =============================================================================

"""
Discount offer type enumeration.
Categorizes the type of discount or promotional offer.
"""
enum DiscountOfferType {
  """
  Introductory offer for new subscribers (first-time purchase discount)
  """
  Introductory
  """
  Promotional offer for existing or returning subscribers
  """
  Promotional
  """
  One-time product discount (Android only, Google Play Billing 7.0+)
  """
  OneTime
}

"""
Payment mode for subscription offers.
Determines how the user pays during the offer period.
"""
enum PaymentMode {
  """
  Free trial period - no charge during offer
  """
  FreeTrial
  """
  Pay each period at reduced price
  """
  PayAsYouGo
  """
  Pay full discounted amount upfront
  """
  PayUpFront
  """
  Unknown or unspecified payment mode
  """
  Unknown
}

"""
Subscription period unit for cross-platform use.
"""
enum SubscriptionPeriodUnit {
  Day
  Week
  Month
  Year
  Unknown
}

"""
Subscription period value combining unit and count.
"""
type SubscriptionPeriod {
  """
  The period unit (day, week, month, year)
  """
  unit: SubscriptionPeriodUnit!
  """
  The number of units (e.g., 1 for monthly, 3 for quarterly)
  """
  value: Int!
}

"""
Standardized one-time product discount offer.
Provides a unified interface for one-time purchase discounts across platforms.

Currently supported on Android (Google Play Billing 7.0+).
iOS does not support one-time purchase discounts in the same way.

@see https://openiap.dev/docs/features/discount
"""
type DiscountOffer {
  """
  Unique identifier for the offer.
  - iOS: Not applicable (one-time discounts not supported)
  - Android: offerId from ProductAndroidOneTimePurchaseOfferDetail
  """
  id: ID

  """
  Formatted display price string (e.g., "$4.99")
  """
  displayPrice: String!

  """
  Numeric price value
  """
  price: Float!

  """
  Currency code (ISO 4217, e.g., "USD")
  """
  currency: String!

  """
  Type of discount offer
  """
  type: DiscountOfferType!

  # ---------------------------------------------------------------------------
  # Android-specific fields (suffix: Android)
  # ---------------------------------------------------------------------------

  """
  [Android] Offer token required for purchase.
  Must be passed to requestPurchase() when purchasing with this offer.
  """
  offerTokenAndroid: String

  """
  [Android] List of tags associated with this offer.
  """
  offerTagsAndroid: [String!]

  """
  [Android] Original full price in micro-units before discount.
  Divide by 1,000,000 to get the actual price.
  Use for displaying strikethrough original price.
  """
  fullPriceMicrosAndroid: String

  """
  [Android] Percentage discount (e.g., 33 for 33% off).
  Only present for percentage-based discounts.
  """
  percentageDiscountAndroid: Int

  """
  [Android] Fixed discount amount in micro-units.
  Only present for fixed amount discounts.
  """
  discountAmountMicrosAndroid: String

  """
  [Android] Formatted discount amount string (e.g., "$5.00 OFF").
  """
  formattedDiscountAmountAndroid: String

  """
  [Android] Valid time window for the offer.
  Contains startTimeMillis and endTimeMillis.
  """
  validTimeWindowAndroid: ValidTimeWindowAndroid

  """
  [Android] Limited quantity information.
  Contains maximumQuantity and remainingQuantity.
  """
  limitedQuantityInfoAndroid: LimitedQuantityInfoAndroid

  """
  [Android] Pre-order details if this is a pre-order offer.
  Available in Google Play Billing Library 8.1.0+
  """
  preorderDetailsAndroid: PreorderDetailsAndroid

  """
  [Android] Rental details if this is a rental offer.
  """
  rentalDetailsAndroid: RentalDetailsAndroid
}

"""
Standardized subscription discount/promotional offer.
Provides a unified interface for subscription offers across iOS and Android.

Both platforms support subscription offers with different implementations:
- iOS: Introductory offers, promotional offers with server-side signatures
- Android: Offer tokens with pricing phases

@see https://openiap.dev/docs/types/ios#discount-offer
@see https://openiap.dev/docs/types/android#subscription-offer
"""
type SubscriptionOffer {
  """
  Unique identifier for the offer.
  - iOS: Discount identifier from App Store Connect
  - Android: offerId from ProductSubscriptionAndroidOfferDetails
  """
  id: ID!

  """
  Formatted display price string (e.g., "$9.99/month")
  """
  displayPrice: String!

  """
  Numeric price value
  """
  price: Float!

  """
  Currency code (ISO 4217, e.g., "USD")
  """
  currency: String

  """
  Type of subscription offer (Introductory or Promotional)
  """
  type: DiscountOfferType!

  """
  Subscription period for this offer
  """
  period: SubscriptionPeriod

  """
  Number of periods the offer applies
  """
  periodCount: Int

  """
  Payment mode during the offer period
  """
  paymentMode: PaymentMode

  # ---------------------------------------------------------------------------
  # iOS-specific fields (suffix: IOS)
  # ---------------------------------------------------------------------------

  """
  [iOS] Key identifier for signature validation.
  Used with server-side signature generation for promotional offers.
  """
  keyIdentifierIOS: String

  """
  [iOS] Cryptographic nonce (UUID) for signature validation.
  Must be generated server-side for each purchase attempt.
  """
  nonceIOS: String

  """
  [iOS] Server-generated signature for promotional offer validation.
  Required when applying promotional offers on iOS.
  """
  signatureIOS: String

  """
  [iOS] Timestamp when the signature was generated.
  Used for signature validation.
  """
  timestampIOS: Float

  """
  [iOS] Number of billing periods for this discount.
  """
  numberOfPeriodsIOS: Int

  """
  [iOS] Localized price string.
  """
  localizedPriceIOS: String

  # ---------------------------------------------------------------------------
  # Android-specific fields (suffix: Android)
  # ---------------------------------------------------------------------------

  """
  [Android] Base plan identifier.
  Identifies which base plan this offer belongs to.
  """
  basePlanIdAndroid: String

  """
  [Android] Offer token required for purchase.
  Must be passed to requestPurchase() when purchasing with this offer.
  """
  offerTokenAndroid: String

  """
  [Android] List of tags associated with this offer.
  """
  offerTagsAndroid: [String!]

  """
  [Android] Pricing phases for this subscription offer.
  Contains detailed pricing information for each phase (trial, intro, regular).
  """
  pricingPhasesAndroid: PricingPhasesAndroid
}

# Initialization configuration
"""
Connection initialization configuration
"""
input InitConnectionConfig {
  """
  Alternative billing mode for Android
  If not specified, defaults to NONE (standard Google Play billing)
  @deprecated Use enableBillingProgramAndroid instead.
  Use USER_CHOICE_BILLING for user choice billing, EXTERNAL_OFFER for alternative only.
  """
  alternativeBillingModeAndroid: AlternativeBillingModeAndroid
  """
  Enable a specific billing program for Android (7.0+)
  When set, enables the specified billing program for external transactions.
  - USER_CHOICE_BILLING: User can select between Google Play or alternative (7.0+)
  - EXTERNAL_CONTENT_LINK: Link to external content (8.2.0+)
  - EXTERNAL_OFFER: External offers for digital content (8.2.0+)
  - EXTERNAL_PAYMENTS: Developer provided billing, Japan only (8.3.0+)
  """
  enableBillingProgramAndroid: BillingProgramAndroid
}
